#!/usr/bin/env bash

# Multiline directories array
directories=(
    ~/work/builds
    ~/projects
    ~/
    ~/work
    ~/personal
)

# Check if directories or symbolic links to directories exist and add them to a new array
existing_directories=()
for dir in "${directories[@]}"; do
    if [ -d "$dir" ]; then
        existing_directories+=("$dir")
    elif [ -L "$dir" ]; then
        link_target=$(readlink -f "$dir")
        if [ -d "$link_target" ]; then
            existing_directories+=("$dir -> $link_target")
        else
            echo "Symbolic link '$dir' target '$link_target' does not exist."
        fi
    else
        echo "Neither directory nor symbolic link: $dir"
    fi
done

# Construct find command with existing directories
#find_command="find ${existing_directories[*]} -mindepth 1 -maxdepth 1 -type d"
find_command="find ${existing_directories[*]} -mindepth 1 -maxdepth 1 \( -type d -o -type l \)"
if [[ $# -eq 1 ]]; then
    selected=$1
else
    # Use fzf to select from the found directories
    selected=$(eval "$find_command" | fzf -s)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

# Start tmux session
if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c "$selected"
    exit 0
fi

# Create a detached session if it doesn't exist
if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c "$selected"
fi

# Switch to the tmux session
tmux switch-client -t $selected_name
